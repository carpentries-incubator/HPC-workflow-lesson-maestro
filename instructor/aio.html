<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>HPC Workflow Management with Maestro: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="manifest" href="../site.webmanifest">
<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><abbr class="badge badge-light" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="background-color: #FF4955; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #000">
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
            Pre-Alpha
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Learner View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      HPC Workflow Management with Maestro
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            HPC Workflow Management with Maestro
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<hr>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a class="btn btn-primary" href="../aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  HPC Workflow Management with Maestro
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Learner View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Running commands with Maestro</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-maestro_on_the_cluster.html">2. Running Maestro on the cluster</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-maestro-and-mpi.html">3. MPI applications and Maestro</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-placeholders.html">4. Placeholders</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-chaining_rules.html">5. Chaining rules</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-multiple-parameters.html">6. Multiple parameters</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="../instructor/aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-introduction"><p>Content from <a href="01-introduction.html">Running commands with Maestro</a></p>
<hr>
<p>Last updated on 2024-04-02 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/01-introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 60 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I run a simple command with Maestro?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Create a Maestro YAML file”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="what-is-the-workflow-im-interested-in"><h2 class="section-heading">What is the workflow I’m interested in?<a class="anchor" aria-label="anchor" href="#what-is-the-workflow-im-interested-in"></a>
</h2>
<hr class="half-width">
<p>In this lesson we will make an experiment that takes an application
which runs in parallel and investigate it’s scalability. To do that we
will need to gather data, in this case that means running the
application multiple times with different numbers of CPU cores and
recording the execution time. Once we’ve done that we need to create a
visualisation of the data to see how it compares against the ideal
case.</p>
<p>From the visualisation we can then decide at what scale it makes most
sense to run the application at in production to maximise the use of our
CPU allocation on the system.</p>
<p>We could do all of this manually, but there are useful tools to help
us manage data analysis pipelines like we have in our experiment. Today
we’ll learn about one of those: Maestro.</p>
<p>In order to get started with Maestro, let’s begin by taking a simple
command and see how we can run that via Maestro. Let’s choose the
command <code>hostname</code> which prints out the name of the host
where the command is executed:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">janeh@pascal83:~$</span> hostname</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">pascal83</span></span></code></pre>
</div>
<p>That prints out the result but Maestro relies on files to know the
status of your workflow, so let’s redirect the output to a file:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">janeh@pascal83:~$</span> hostname <span class="op">&gt;</span> hostname_login.txt</span></code></pre>
</div>
</section><section id="writing-a-maestro-yaml"><h2 class="section-heading">Writing a Maestro YAML<a class="anchor" aria-label="anchor" href="#writing-a-maestro-yaml"></a>
</h2>
<hr class="half-width">
<p>Edit a new text file named <code>hostname.yaml</code>.</p>
<p>Contents of <code>hostname.yaml</code>:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Hostnames</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Report a node's hostname.</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hostname-login</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the login node's hostname to a file</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>              hostname &gt; hostname_login.txt</span></code></pre>
</div>
<div id="key-points-about-this-file" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="key-points-about-this-file" class="callout-inner">
<h3 class="callout-title">Key points about this file<a class="anchor" aria-label="anchor" href="#key-points-about-this-file"></a>
</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>The name of <code>hostname.yaml</code> is not very important; it
gives us information about file contents and type, but maestro will
behave the same if you rename it to <code>hostname</code> or
<code>foo.txt</code>.</li>
<li>The file specifies fields in a hierarchy. For example,
<code>name</code>, <code>description</code>, and <code>run</code> are
all passed to <code>study</code> and are at the same level in the
hierarchy. <code>description</code> and <code>study</code> are both at
the top level in the hierarchy.</li>
<li>Indentation indicates the hierarchy and should be consistent. For
example, all the fields passed directly to <code>study</code> are
indented relative to <code>study</code> and their indentation is all the
same.</li>
<li>The commands executed during the study are given under
<code>cmd</code>. Starting this entry with <code>|</code> and a newline
character allows us to specify multiple commands.</li>
<li>The example YAML file above is pretty minimal; all fields shown are
required.</li>
<li>The names given to <code>study</code> can include letters, numbers,
and special characters.</li>
</ol>
</div>
</div>
</div>
<p>Back in the shell we’ll run our new rule. At this point, we may see
an error if a required field is missing or if our indentation is
inconsistent.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">$</span> maestro run hostname.yaml</span></code></pre>
</div>
<div id="bash-maestro-command-not-found..." class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="bash-maestro-command-not-found..." class="callout-inner">
<h3 class="callout-title">
<code>bash: maestro: command not found...</code><a class="anchor" aria-label="anchor" href="#bash-maestro-command-not-found..."></a>
</h3>
<div class="callout-content">
<p>If your shell tells you that it cannot find the command
<code>maestro</code> then we need to make the software available
somehow. In our case, this means activating the python virtual
environment where maestro is installed.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="bu">source</span> /usr/global/docs/training/janeh/maestro_venv/bin/activate</span></code></pre>
</div>
<p>You can tell this command has already been run when
<code>(maestro_venv)</code> appears before your command prompt:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">janeh@pascal83:~$</span> source /usr/global/docs/training/janeh/maestro_venv/bin/activate</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span></span></code></pre>
</div>
<p>Now that the <code>maestro_venv</code> virtual environment has been
activated, the <code>maestro</code> command should be available, but
let’s double check</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span> which maestro</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/usr/global/docs/training/janeh/maestro_venv/bin/maestro</code></pre>
</div>
</div>
</div>
</div>
</section><section id="running-maestro"><h2 class="section-heading">Running maestro<a class="anchor" aria-label="anchor" href="#running-maestro"></a>
</h2>
<hr class="half-width">
<p>Once you have <code>maestro</code> available to you, run
<code>maestro run hostname.yaml</code> and enter <code>y</code> when
prompted</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span> maestro run hostname.yaml</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="ex">[2024-03-20</span> 15:39:34: INFO] INFO Logging Level <span class="at">--</span> Enabled</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="ex">[2024-03-20</span> 15:39:34: WARNING] WARNING Logging Level <span class="at">--</span> Enabled</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="ex">[2024-03-20</span> 15:39:34: CRITICAL] CRITICAL Logging Level <span class="at">--</span> Enabled</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="ex">[2024-03-20</span> 15:39:34: INFO] Loading specification <span class="at">--</span> path = hostname.yaml</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="ex">[2024-03-20</span> 15:39:34: INFO] Directory does not exist. Creating directories to /g/g0/janeh/Hostnames_20240320-153934/logs</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="ex">[2024-03-20</span> 15:39:34: INFO] Adding step <span class="st">'hostname-login'</span> to study <span class="st">'Hostnames'</span>...</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="ex">[2024-03-20</span> 15:39:34: INFO]</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="ex">------------------------------------------</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="ex">Submission</span> attempts =       1</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="ex">Submission</span> restart limit =  1</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="ex">Submission</span> throttle limit = 0</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="ex">Use</span> temporary directory =   False</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="ex">Hash</span> workspaces =           False</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="ex">Dry</span> run enabled =           False</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="ex">Output</span> path =               /g/g0/janeh/Hostnames_20240320-153934</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="ex">------------------------------------------</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="ex">Would</span> you like to launch the study<span class="pp">?</span> <span class="pp">[</span><span class="ss">yn</span><span class="pp">]</span> y</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="ex">Study</span> launched successfully.</span></code></pre>
</div>
<p>and look at the outputs. You should have a new directory whose name
includes a date and timestamp and that starts with the <code>name</code>
given under <code>description</code> at the top of
<code>hostname.yaml</code>.</p>
<p>In that directory will be a subdirectory for every <code>study</code>
run from <code>hostname.yaml</code>. The subdirectories for each study
include all output files for that study</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span> cd Hostnames_20240320-153934/</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~/Hostnames_20240320-153934$</span> ls</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>batch.info      Hostnames.pkl        Hostnames.txt  logs  status.csv
hostname-login  Hostnames.study.pkl  hostname.yaml  meta</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~/Hostnames_20240320-153934$</span> cd hostname-login/</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~/Hostnames_20240320-153934/hostname-login$</span> ls</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="kw">```</span><span class="ex">output</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="ex">hostname-login.2284862.err</span>  hostname-login.2284862.out  hostname-login.sh  hostname_login.txt</span></code></pre>
</div>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>To which file will the login node’s hostname, <code>pascal83</code>,
be written?</p>
<ol style="list-style-type: decimal">
<li>hostname-login.2284862.err</li>
<li>hostname-login.2284862.out</li>
<li>hostname-login.sh</li>
<li>hostname_login.txt</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<ol start="4" style="list-style-type: decimal">
<li>hostname_login.txt</li>
</ol>
<p>In the original <code>hostname.yaml</code> file that we ran, we
specified that hostname would be written to
<code>hostname_login.txt</code>, and this is where we’ll see that
output, if the run worked!</p>
</div>
</div>
</div>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>This one is tricky! In the example above, <code>pascal83</code> was
written to
<code>.../Hostnames_{date}_{time}/hostname-login/hostname_login.txt</code>.</p>
<p>Where would <code>Hello</code> be written for the following YAML?</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> MyHello</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Report a node's hostname.</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> give-salutation</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the login node's hostname to a file</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>              echo "hello" &gt; greeting.txt</span></code></pre>
</div>
<ol style="list-style-type: decimal">
<li><code>.../give-salutation_{date}_{time}/greeting/greeting.txt</code></li>
<li><code>.../greeting_{date}_{time}/give_salutation/greeting.txt</code></li>
<li><code>.../MyHello_{date}_{time}/give-salutation/greeting.txt</code></li>
<li><code>.../MyHello_{date}_{time}/greeting/greeting.txt</code></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<ol start="3" style="list-style-type: decimal">
<li><code>.../MyHello_{date}_{time}/give-salutation/greeting.txt</code></li>
</ol>
<p>The toplevel folder created starts with the <code>name</code> field
under <code>description</code>; here, that’s <code>MyHello</code>. Its
subdirectory is named after the <code>study</code>; here, that’s
<code>give-salutation</code>. The file created is
<code>greeting.txt</code> and this stores the output of
<code>echo "hello"</code>.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“You execute <code>maestro run</code> with a YAML file including
information about your run.”</li>
<li>“Your run includes a description and at least one study (a step in
your run).”</li>
<li>“Your maestro run creates a directory with subdirectories and
outputs for each study.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-02-maestro_on_the_cluster"><p>Content from <a href="02-maestro_on_the_cluster.html">Running Maestro on the cluster</a></p>
<hr>
<p>Last updated on 2024-04-16 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/02-maestro_on_the_cluster.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 50 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="section level1">
<h1 id="how-do-i-run-maestro-on-the-cluster">How do I run Maestro on the cluster?<a class="anchor" aria-label="anchor" href="#how-do-i-run-maestro-on-the-cluster"></a>
</h1>
<p>What happens when we want to run on the cluster (“to run a batch
job”)rather than the login node? The cluster we are using uses Slurm,
and Maestro has built in support for Slurm. We just need to tell Maestro
which resources we need Slurm to grab for our run.</p>
<p>First, we need to add a <code>batch</code> block to our YAML file,
where we’ll provide the names of the machine, bank, and queue in which
your jobs should run.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # enter the machine you'll run on</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # enter the bank to charge</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # enter the partition in which your job should run</span></span></code></pre>
</div>
<p>Second, we need to specify the number of nodes, number of processes,
and walltime for <em>each step</em> in our YAML file. This information
goes under each step’s <code>run</code> field. Here we specify 1 node, 1
process, and a time limit of 30 seconds:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="at">(...)</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>               hostname &gt;&gt; hostname.txt</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<p>Whereas <code>run</code> previously held only info about the command
we wanted to execute, steps run on the cluster include a specification
of the resources needed in order to execute. <strong>Note</strong> that
the format of the walltime includes quotation marks –
“{Hours}:{Minutes}:{Seconds}”.</p>
<p>With these changes, our updated YAML file might look like</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Hostnames</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Report a node's hostname.</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hostname-login</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the login node's hostname to a file</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>              hostname &gt; hostname_login.txt</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hostname_batch</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the node's hostname to a file</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>               hostname &gt;&gt; hostname.txt</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<p>Note that we left the rule <code>hostname-login</code> as is. Because
we do not specify any info for slurm under this original step’s
<code>run</code> field – like nodes, processes, or walltime – this step
will continue running on the login node and only
<code>hostname_batch</code> will be handed off to slurm.</p>
<div id="running-on-the-cluster" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="running-on-the-cluster" class="callout-inner">
<h3 class="callout-title">Running on the cluster<a class="anchor" aria-label="anchor" href="#running-on-the-cluster"></a>
</h3>
<div class="callout-content">
<p>Modify your YAML file, <code>hostname.yaml</code> to execute
<code>hostname</code> on the <em>cluster</em>. Run with 1 node and 1
process using the bank <code>guest</code> on the partition
<code>psummer</code> on <code>quartz</code>.</p>
<p>If you run this multiple times, do you always run on the same node?
(Is the hostname printed always the same?)</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The contents of <code>hostname.yaml</code> should look something
like:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Hostnames</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Report a node's hostname.</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guest</span><span class="co"> # bank</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> psummer</span><span class="co"> # partition</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hostname-login</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the login node's hostname to a file</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>              hostname &gt; hostname_login.txt</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> hostname_batch</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the node's hostname to a file</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>               hostname &gt;&gt; hostname.txt</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<p>When you run this job, a directory called <code>Hostname_...</code>
will be created. If you look in the subdirectory
<code>hostname_batch</code>, you’ll find a file called
<code>hostname.txt</code> with info about the compute node where the
<code>hostname</code> command ran. If you run the job multiple times,
you will probably land on different nodes; this means you’ll see
different node numbers in different hostname.txt files. If you see the
same number more than once, don’t worry! If you get an answer other than
<code>pascal83</code>, you’re doing it correctly. :)</p>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="outputs-from-a-batch-job">Outputs from a batch job<a class="anchor" aria-label="anchor" href="#outputs-from-a-batch-job"></a>
</h2>
<p>When running in batch, <code>maestro run...</code> will create a new
directory with the same naming scheme as seen in episode 1, and that
directory will contain subdirectories for all studies. The
<code>hostname_batch</code> subdirectory has four output files, but this
time the file ending with extension <code>.sh</code> is a slurm
submission script</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~/Hostnames_20240320-170150/hostname_batch$</span> ls</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">hostname.err</span>  hostname.out  hostname.slurm.sh  hostname.txt</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~/Hostnames_20240320-170150/hostname_batch$</span> cat hostname.slurm.sh</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">#SBATCH --nodes=1</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">#SBATCH --partition=pvis</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">#SBATCH --account=lc</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">#SBATCH --time=00:00:30</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">#SBATCH --job-name="hostname"</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co">#SBATCH --output="hostname.out"</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co">#SBATCH --error="hostname.err"</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co">#SBATCH --comment "Write the node's hostname to a file"</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="fu">hostname</span> <span class="op">&gt;</span> hostname.txt</span></code></pre>
</div>
<p>Maestro uses the info from your YAML file to write this script and
then submits it to the scheduler for you. Soon after you run on the
cluster via <code>maestro run hostname.yaml</code>, you should be able
to see the job running or finishing up in the queue with the command
<code>squeue -u &lt;your username</code>. For example,</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span> maestro run batch-hostname.yaml</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="ex">[2024-03-20</span> 17:31:37: INFO] INFO Logging Level <span class="at">--</span> Enabled</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="ex">[2024-03-20</span> 17:31:37: WARNING] WARNING Logging Level <span class="at">--</span> Enabled</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="ex">[2024-03-20</span> 17:31:37: CRITICAL] CRITICAL Logging Level <span class="at">--</span> Enabled</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="ex">[2024-03-20</span> 17:31:37: INFO] Loading specification <span class="at">--</span> path = batch-hostname.yaml</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="ex">[2024-03-20</span> 17:31:37: INFO] Directory does not exist. Creating directories to /g/g0/janeh/Hostnames_20240320-173137/logs</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="ex">[2024-03-20</span> 17:31:37: INFO] Adding step <span class="st">'hostname-login'</span> to study <span class="st">'Hostnames'</span>...</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="ex">[2024-03-20</span> 17:31:37: INFO] Adding step <span class="st">'hostname_batch'</span> to study <span class="st">'Hostnames'</span>...</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="ex">[2024-03-20</span> 17:31:37: INFO]</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="ex">------------------------------------------</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="ex">Submission</span> attempts =       1</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="ex">Submission</span> restart limit =  1</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="ex">Submission</span> throttle limit = 0</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="ex">Use</span> temporary directory =   False</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="ex">Hash</span> workspaces =           False</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="ex">Dry</span> run enabled =           False</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="ex">Output</span> path =               /g/g0/janeh/Hostnames_20240320-173137</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="ex">------------------------------------------</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="ex">Would</span> you like to launch the study<span class="pp">?</span> <span class="pp">[</span><span class="ss">yn</span><span class="pp">]</span> y</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="ex">Study</span> launched successfully.</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span> squeue <span class="at">-u</span> janeh</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>             <span class="ex">JOBID</span> PARTITION     NAME     USER ST       TIME  NODES NODELIST<span class="er">(</span><span class="ex">REASON</span><span class="kw">)</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>            <span class="ex">718308</span>      pvis hostname    janeh  R       0:01      1 pascal13</span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“You can run on the cluster by including info for Slurm in your
Maestro YAML file”</li>
<li>“Maestro generates and submits its own batch scripts to your
scheduler.”</li>
<li>“Steps without Slurm parameters will run on the login node by
default.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</div></section><section id="aio-03-maestro-and-mpi"><p>Content from <a href="03-maestro-and-mpi.html">MPI applications and Maestro</a></p>
<hr>
<p>Last updated on 2024-04-17 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/03-maestro-and-mpi.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 50 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I run an MPI application via Maestro on the cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Define rules to run parallel applications on the cluster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Now it’s time to start getting back to our real workflow. We can
execute a command on the cluster, but how do we effectively leverage
cluster resources and actually run in parallel? In this episode, we’ll
learn how to execute an application that can be run in parallel.</p>
<p>Our application is called <code>amdahl</code> and is available in the
python virtual environment we’re already using for <code>maestro</code>.
Check that you have access to this binary by running
<code>which amdahl</code> at the command line. You should see something
like</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span> which amdahl</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/usr/global/docs/training/janeh/maestro_venv/bin/amdahl</code></pre>
</div>
<p>We’ll use this binary to see how efficiently we can run a parallel
program on our cluster – i.e. how the amount of work done per processor
changes as we use more processors.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Without using maestro, simply run amdahl on your login node by typing
<code>amdahl</code> on the command line and hitting enter.</p>
<pre><code><span><span class="va">amdahl</span></span></code></pre>
<p>What is amdahl doing?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>You should see output that looks roughly like</p>
<pre><code>(maestro_venv) janeh@pascal83:~$ amdahl
Doing 30.000000 seconds of 'work' on 1 processor,
 which should take 30.000000 seconds with 0.800000 parallel proportion of the workload.

  Hello, World! I am process 0 of 1 on pascal83. I will do all the serial 'work' for 5.243022 seconds.
  Hello, World! I am process 0 of 1 on pascal83. I will do parallel 'work' for 25.233023 seconds.

Total execution time (according to rank 0): 30.537750 seconds</code></pre>
<p>In short, this program prints the amount of time spent working
serially and the amount of time it spends on the parallel section of a
code. On the login node, only a single task is created, so there
shouldn’t be any speedup from running in parallel, but soon we’ll use
more tasks to run this program!</p>
</div>
</div>
</div>
</div>
<p>In the last challenge, we saw how the <code>amdahl</code> executable
behaves when run on the login node. In the next challenge, let’s get
<code>amdahl</code> running on the login node using
<code>maestro</code>.</p>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>Using what you learned in episode 1, create a Maestro YAML file that
runs <code>amdahl</code> on the login node and captures the output in a
file.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>Your YAML file might be named <code>amdahl.yaml</code> and its
contents might look like</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run the amdahl executable</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>               amdahl &gt;&gt; amdahl.out</span></code></pre>
</div>
<p>and you would run with <code>maestro run amdahl.yaml</code>.</p>
</div>
</div>
</div>
</div>
<p>Next, let’s get <code>amdahl</code> running in batch, on a compute
node.</p>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge3"></a>
</h3>
<div class="callout-content">
<p>Update <code>amdahl.yaml</code> from the last challenge so that this
workflow runs on a compute node with a single task. Use the examples
from episode 2!</p>
<p>Once you’ve done this. Examine the output and verify that only a
single task is reporting on its work in your output file.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Show me the solution</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<p>The contents of <code>amdahl.yaml</code> should now look something
like</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run on the cluster</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run on the cluster</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>               amdahl &gt;&gt; amdahl.out</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<p>In your <code>amdahl.out</code> file, you should see that only a
single task — task 0 of 1 — is mentioned.</p>
<p>Note — Exact wording for names and descriptions is not important, but
should help you to remember what this file and its study are doing.</p>
</div>
</div>
</div>
</div>
<div id="challenge4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge4"></a>
</h3>
<div class="callout-content">
<p>After checking that <code>amdahl.yaml</code> looks similar to the
solution above, update the number of <code>nodes</code> and
<code>procs</code> each to <code>2</code> and rerun
<code>maestro run amdahl.yaml</code>. How many processes report their
work in the output file?</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">Show me the solution</h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<p>Your YAML files contents are now updated to</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run on the cluster</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run on the cluster</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>               amdahl &gt;&gt; amdahl.out</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<p>In your output file <code>amdahl.out</code>, you probably still see
output looking something like</p>
<pre><code>Doing 30.000000 seconds of 'work' on 1 processor,
 which should take 30.000000 seconds with 0.800000 parallel proportion of the workload.

  Hello, World! I am process 0 of 1 on pascal17. I will do all the serial 'work' for 5.324555 seconds.
  Hello, World! I am process 0 of 1 on pascal17. I will do parallel 'work' for 22.349517 seconds.

Total execution time (according to rank 0): 27.755552 seconds</code></pre>
<p>Notice that this output refers to only “1 processor” and mentions
only one process. We requested two processes, but only a single one
reports back!</p>
<p>So what’s going on? If your job were really <em>using</em> both tasks
that were assigned to it, then both would have written to
<code>amdahl.out</code>.</p>
</div>
</div>
</div>
</div>
<p>Here’s the takeaway from the challenges above: It’s not enough to
have both parallel resources and a binary/executable/program that is
enabled to run in parallel. We actually need to invoke MPI in order to
force our parallel program to use parallel resources.</p>
<section id="maestro-and-mpi"><h2 class="section-heading">Maestro and MPI<a class="anchor" aria-label="anchor" href="#maestro-and-mpi"></a>
</h2>
<hr class="half-width">
<p>We didn’t really run an MPI application in the last section as we
only ran on one processor. How do we request to run using multiple
processes for a single step?</p>
<p>The answer is that we have to tell Slurm that we want to use MPI. In
the Intro to HPC lesson, the episodes introducing Slurm and running
parallel jobs showed that commands to run in parallel need to use
<code>srun</code>. <code>srun</code> talks to MPI and allows multiple
processors to coordinate work. A call to <code>srun</code> might look
something like</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">srun</span> <span class="at">-N</span> {# of nodes} <span class="at">-n</span> {number of processes} amdahl <span class="op">&gt;&gt;</span> amdahl.out</span></code></pre>
</div>
<p>To make this easier, Maestro offers the shorthand
<code>$(LAUNCHER)</code>. Maestro will replace instances of
<code>$(LAUNCHER)</code> with a call to <code>srun</code>, specifying as
many nodes and processes we’ve already told Slurm we want to use.</p>
<div id="challenge5" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge5"></a>
</h3>
<div class="callout-content">
<p>Update <code>amdahl.yaml</code> to include <code>$(LAUNCHER)</code>
before the call to <code>amdahl</code> in your study’s <code>cmd</code>
field. Run maestro with the updated YAML and explore the outputs. How
many tasks are mentioned in <code>amdahl.out</code>? In the Slurm
submission script created by Maestro (included in the same subdirectory
as <code>amdahl.out</code>), what text was used to replace
<code>$(LAUNCHER)</code>?</p>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5">Show me the solution</h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" aria-labelledby="headingSolution5" data-bs-parent="#accordionSolution5">
<div class="accordion-body">
<p>The updated YAML should look something like</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>               $(LAUNCHER) amdahl &gt;&gt; amdahl.out</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<p>Your output file <code>Amdahl_.../amdahl/amdahl.out</code> should
include “Doing 30.000000 seconds of ‘work’ on 2 processors” and the
submission script <code>Amdahl_.../amdahl/amdahl.slurm.sh</code> should
include the line “srun -n 2 -N 2 amdahl &gt;&gt; amdahl.out”. Maestro
substituted <code>srun -n 2 -N 2</code> for
<code>$(LAUNCHER)</code>!</p>
</div>
</div>
</div>
</div>
<div id="commenting-maestro-yaml-files" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="commenting-maestro-yaml-files" class="callout-inner">
<h3 class="callout-title">Commenting Maestro YAML files<a class="anchor" aria-label="anchor" href="#commenting-maestro-yaml-files"></a>
</h3>
<div class="callout-content">
<p>In the solution from the last challenge, the line beginning
<code>#</code> is a comment line. Hopefully you are already in the habit
of adding comments to your own scripts. Good comments make any script
more readable, and this is just as true with our YAML files.</p>
</div>
</div>
</div>
</section><section id="customizing-amdahl-output"><h2 class="section-heading">Customizing amdahl output<a class="anchor" aria-label="anchor" href="#customizing-amdahl-output"></a>
</h2>
<hr class="half-width">
<p>Another thing about our application <code>amdahl</code> is that we
ultimately want to process the output to generate our scaling plot. The
output right now is useful for reading but makes processing harder.
<code>amdahl</code> has an option that actually makes this easier for
us. To see the <code>amdahl</code> options we can use</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span> amdahl <span class="at">--help</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>usage: amdahl [-h] [-p [PARALLEL_PROPORTION]] [-w [WORK_SECONDS]] [-t] [-e]

options:
  -h, --help            show this help message and exit
  -p [PARALLEL_PROPORTION], --parallel-proportion [PARALLEL_PROPORTION]
                        Parallel proportion should be a float between 0 and 1
  -w [WORK_SECONDS], --work-seconds [WORK_SECONDS]
                        Total seconds of workload, should be an integer greater than 0
  -t, --terse           Enable terse output
  -e, --exact           Disable random jitter</code></pre>
</div>
<p>The option we are looking for is <code>--terse</code>, and that will
make <code>amdahl</code> print output in a format that is much easier to
process, JSON. JSON format in a file typically uses the file extension
<code>.json</code> so let’s add that option to our <code>shell</code>
command <em>and</em> change the file format of the <code>output</code>
to match our new command:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse &gt;&gt; amdahl.json</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:01:30"</span></span></code></pre>
</div>
<p>There was another parameter for <code>amdahl</code> that caught my
eye. <code>amdahl</code> has an option
<code>--parallel-proportion</code> (or <code>-p</code>) which we might
be interested in changing as it changes the behaviour of the code, and
therefore has an impact on the values we get in our results. Let’s try
specifying a parallel proportion of 90%:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p .9 &gt;&gt; amdahl.json</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<div id="challenge6" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge6"></a>
</h3>
<div class="callout-content">
<p>Create a YAML file for a value of <code>-p</code> of 0.999 (the
default value is 0.8) for the case where we have a single node and 4
parallel processes.</p>
</div>
</div>
</div>
<div id="accordionSolution6" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution6" aria-expanded="false" aria-controls="collapseSolution6">
  <h4 class="accordion-header" id="headingSolution6">Show me the solution</h4>
</button>
<div id="collapseSolution6" class="accordion-collapse collapse" aria-labelledby="headingSolution6" data-bs-parent="#accordionSolution6">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p .999 &gt;&gt; amdahl.json</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="environment-variables"><h2 class="section-heading">Environment variables<a class="anchor" aria-label="anchor" href="#environment-variables"></a>
</h2>
<hr class="half-width">
<p>Our current directory is probably starting to fill up with
directories starting with <code>Amdahl_...</code>, distinguished only by
dates and timestamps. It’s probably best to group runs into separate
folders to keep things tidy. One way we can do this is by specifying an
<code>env</code> section in our YAML file with a variable called
<code>OUTPUT_PATH</code> specified in this format:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode3</span></span></code></pre>
</div>
<p>This <code>env</code> block goes above our <code>study</code> block;
<code>env</code> is at the same level of indentation as
<code>study</code>. In this case, directories created by runs using this
<code>OUTPUT_PATH</code> will all be grouped inside the directory
<code>Episode3</code>, to help us group runs by where we are in the
lesson.</p>
<div id="challenge7" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge7"></a>
</h3>
<div class="callout-content">
<p>Modify your YAML so that subsequent runs will be grouped into a
shared parent directory (for example, <code>Episode3</code>, as
above).</p>
</div>
</div>
</div>
<div id="accordionSolution7" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution7" aria-expanded="false" aria-controls="collapseSolution7">
  <h4 class="accordion-header" id="headingSolution7">Show me the solution</h4>
</button>
<div id="collapseSolution7" class="accordion-collapse collapse" aria-labelledby="headingSolution7" data-bs-parent="#accordionSolution7">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode3</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p .999 &gt;&gt; amdahl.json</span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="dry-run---dry-mode"><h2 class="section-heading">Dry-run (<code>--dry</code>) mode<a class="anchor" aria-label="anchor" href="#dry-run---dry-mode"></a>
</h2>
<hr class="half-width">
<p>It’s often useful to run Maestro in <code>--dry</code> mode, which
causes Maestro to create scripts and the directory structure without
actually running jobs. You will see this parameter if you run
<code>maestro run --help</code>.</p>
<div id="challenge8" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge8"></a>
</h3>
<div class="callout-content">
<p>Do a dry-run using the script created in the last challenge. This
should help you verify that a new directory “Episode3” gets created for
runs from this episode.</p>
</div>
</div>
</div>
<div id="accordionSolution8" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution8" aria-expanded="false" aria-controls="collapseSolution8">
  <h4 class="accordion-header" id="headingSolution8">Show me the solution</h4>
</button>
<div id="collapseSolution8" class="accordion-collapse collapse" aria-labelledby="headingSolution8" data-bs-parent="#accordionSolution8">
<div class="accordion-body">
<p>After running</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="ex">maestro</span> run <span class="at">--dry</span> amdahl.yaml</span></code></pre>
</div>
<p>a directory path of the form
<code>Episode3/Amdahl_{DATE}_{TIME}/amdahl</code> should be created.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Adding <code>$(LAUNCHER)</code> before commands signals to Maestro
to use MPI via <code>srun</code>.”</li>
<li>“New Maestro runs can be grouped within a new directory specified by
the environment variable <code>OUTPUT_PATH</code>”</li>
<li>You can use <code>--dry</code> to verify that the expected directory
structure and scripts are created by a given Maestro YAML file.</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-04-placeholders"><p>Content from <a href="04-placeholders.html">Placeholders</a></p>
<hr>
<p>Last updated on 2024-04-17 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/04-placeholders.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 70 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I make a generic rule?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Learn to use variables as placeholders”</li>
<li>“Learn to run many similar Maestro runs at once”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="d.r.y.-dont-repeat-yourself" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="d.r.y.-dont-repeat-yourself" class="callout-inner">
<h3 class="callout-title">D.R.Y. (Don’t Repeat Yourself)<a class="anchor" aria-label="anchor" href="#d.r.y.-dont-repeat-yourself"></a>
</h3>
<div class="callout-content">
<p>In many programming languages, the bulk of the language features are
there to allow the programmer to describe long-winded computational
routines as short, expressive, beautiful code. Features in Python, R, or
Java, such as user-defined variables and functions are useful in part
because they mean we don’t have to write out (or think about) all of the
details over and over again. This good habit of writing things out only
once is known as the “Don’t Repeat Yourself” principle or D.R.Y.</p>
</div>
</div>
</div>
<p>Maestro YAML files are a form of code and, in any code, repetition
can lead to problems (e.g. we rename a data file in one part of the YAML
but forget to rename it elsewhere).</p>
<p>In this episode, we’ll set ourselves up with ways to avoid repeating
ourselves by using <em>environment variables</em> as
<em>placeholders</em>.</p>
<section id="placeholders"><h2 class="section-heading">Placeholders<a class="anchor" aria-label="anchor" href="#placeholders"></a>
</h2>
<hr class="half-width">
<p>Over the course of this lesson, we want to use the
<code>amdahl</code> binary to show how the execution time of a program
changes with the number of processes used. In on our current setup, to
run amdahl for multiple values of <code>procs</code>, we would need to
run our workflow, change <code>procs</code>, rerun, and so forth. We’d
be repeating our workflow a lot, so let’s first try fixing that by
defining multiple rules.</p>
<p>At the end of our last episode, our <code>amdahl.yaml</code> file
contained the sections</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="at">(...)</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode3</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p .999 &gt;&gt; amdahl.json</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<p>Let’s call our existing step <code>amdahl-1</code> (<code>name</code>
under <code>study</code>) and create a second step called
<code>amdahl-2</code> which is exactly the same, except that it will
define <code>procs: 8</code>. While we’re at it, let’s update
<code>OUTPUT_PATH</code> so that it is <code>./Episode4</code>.</p>
<p>The updated part of the script now looks like</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="at">(...)</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode4</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl-1</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p .999 &gt;&gt; amdahl.json</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl-2</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="at">    </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="fu">        cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>             $(LAUNCHER) amdahl --terse -p .999 &gt;&gt; amdahl.json</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a><span class="at">        </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="at">        </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">8</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a><span class="at">        </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<div id="discussion1" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#discussion1"></a>
</h3>
<div class="callout-content">
<p>Update <code>amdahl.yaml</code> to include the new info shown above.
Run a dry run to see what your output directory structure looks
like.</p>
</div>
</div>
</div>
<p>Now let’s start to get rid of some of the redundancy in our new
workflow.</p>
<p>First off, defining the parallel proportion (<code>-p .999</code>) in
two places makes our lives harder. Now if we want to change this value,
we have to update it in two places, but we can make this easier by using
an environment variable.</p>
<p>Let’s create another environment variable in the
<code>variables</code> second under <code>env</code>. We can define a
new parallel proportion as <code>P: .999</code>. Then, under
<code>run</code>’s <code>cmd</code> for each step, we can call this
environment variable with the syntax <code>$(P)</code>.
<code>$(P)</code> holds the place of and will be substituted by
<code>.999</code> when Maestro creates a Slurm submission script for
us.</p>
<p>Let’s also create an environment variable for our output file,
<code>amdahl.json</code> called <code>OUTPUT</code> and then call that
variable from our <code>cmd</code> fields.</p>
<p>Our updated section will now look like this:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="at">(...)</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="at">      </span><span class="fu">P</span><span class="kw">:</span><span class="at"> </span><span class="fl">.999</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode4</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> amdahl.json</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl-1</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="at">    </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="fu">        cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>             $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="at">        </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="at">        </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="at">        </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl-2</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="at">  </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="fu">      cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>           $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="at">      </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="at">      </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">8</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="at">      </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
<p>We’ve added two new placeholders to make our YAML script to make it a
tad bit more efficient. Note that we had already been using a
placeholder given to us by Maestro: $(LAUNCHER) holds the place of a
call to <code>srun &lt;insert resource requests&gt;</code></p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Run your updated <code>amdahl.yaml</code> and check results, to
verify your workflow is working with the changes you’ve made so far.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>The full YAML text is</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="at">      </span><span class="fu">P</span><span class="kw">:</span><span class="at"> </span><span class="fl">.999</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode4</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> amdahl.json</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl-1</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="at">    </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="fu">        cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>             $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="at">        </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="at">        </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">4</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a><span class="at">        </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl-2</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="at">  </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a><span class="fu">      cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>           $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a><span class="at">      </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a><span class="at">      </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">8</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a><span class="at">      </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="maestros-global.parameters"><h2 class="section-heading">Maestro’s global.parameters<a class="anchor" aria-label="anchor" href="#maestros-global.parameters"></a>
</h2>
<hr class="half-width">
<p>We’re almost ready to perform our scaling study – to see how the
execution time changes as we use more processors in the job.
Unfortunately, we’re still repeating ourselves a lot because, in spite
of the environment variables we created, most of the information defined
for steps <code>amdahl-1</code> and <code>amdahl-2</code> is the same.
Only the <code>procs</code> field changes!</p>
<p>A great way to avoid repeating ourselves here by defining a
<strong>parameter</strong> that lists multiple values of tasks and runs
a separate job step for each value. We do this by adding a
<code>global.parameters</code> section at the bottom of the script. We
then define individual parameters within this section. Each parameter
includes a list of <code>values</code> (Each element is used in its own
job step.) and a <code>label</code>. (The <code>label</code> helps
define how the output directory structure is named.)</p>
<p>This is what it looks like to define a global parameter:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">18</span><span class="kw">,</span><span class="at"> </span><span class="dv">24</span><span class="kw">,</span><span class="at"> </span><span class="dv">36</span><span class="kw">]</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span></code></pre>
</div>
<p>Note that the label should include <code>%%</code> as above; the
<code>%%</code> is itself a placeholder! The directory created for the
output of each job step will be identified by the value of each
parameter it used, and the parameter’s value will be inserted to replace
the <code>%%</code>.</p>
<p>Next, we should update the line under <code>run</code> -&gt;
<code>cmd</code> defining <code>procs</code> to include the name of the
parameter enclosed in <code>$()</code>:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> $(TASKS)</span></span></code></pre>
</div>
<p>If we make this change for steps <code>amdahl-1</code> <em>and</em>
<code>amdahl-2</code>, they will now look <em>exactly</em> the same, so
we can simply condense them to one step.</p>
<p>The full YAML file will look like</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="at">      </span><span class="fu">P</span><span class="kw">:</span><span class="at"> </span><span class="fl">.999</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> amdahl.json</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode4</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> $(TASKS)</span></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">18</span><span class="kw">,</span><span class="at"> </span><span class="dv">24</span><span class="kw">,</span><span class="at"> </span><span class="dv">36</span><span class="kw">]</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>Run <code>maestro run --dry amdahl.yaml</code> using the above YAML
file and investigate the resulting directory structure. How does the
list of task values under <code>global.parameters</code> change the
output directory organization?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Under your current working directory, you should see a directory
structure created with the following format –
<code>Episode4/Amdahl_&lt;Date&gt;-&lt;Time&gt;/amdahl</code>. Within
the <code>amdahl</code> subdirectory, you should see one output
directory for each of the values listed for <code>TASKS</code> under
<code>global.parameters</code>:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">...</span><span class="kw">)</span><span class="ex">Episode4/Amdahl_</span><span class="op">&lt;</span>Date<span class="op">&gt;</span>_<span class="op">&lt;</span>Time<span class="op">&gt;</span>/amdahl$ ls</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>TASKS.18  TASKS.2  TASKS.24  TASKS.36  TASKS.4  TASKS.8</code></pre>
</div>
<p>Each <code>TASKS...</code> subdirectory will contain the slurm
submission script to be used if this maestro job is run:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">...</span><span class="kw">)</span><span class="ex">Episode4/Amdahl_</span><span class="op">&lt;</span>Date<span class="op">&gt;</span>_<span class="op">&lt;</span>Time<span class="op">&gt;</span>/amdahl$ ls TASKS.18/</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">amdahl_TASKS.18.slurm.sh</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Run</p>
<pre><code>maestro run amdahl.yaml</code></pre>
<p>before moving on to the next episode, to generate the results for
various task numbers. You’ll be able to see your jobs queueing and
running via <code>squeue -u &lt;username&gt;</code>.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Environment variables are placeholders defined under the
<code>env</code> section of a Maestro YAML.”</li>
<li>“Parameters defined under <code>global.parameters</code> require
lists of values and labels.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-05-chaining_rules"><p>Content from <a href="05-chaining_rules.html">Chaining rules</a></p>
<hr>
<p>Last updated on 2024-04-17 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/05-chaining_rules.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 70 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I combine steps into a workflow?”</li>
<li>“How do I make a step that uses the outputs from a previous
step?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Create workflow pipelines with dependencies”</li>
<li>“Use the outputs of one step as inputs to the next”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="a-pipeline-of-multiple-rules"><h2 class="section-heading">A pipeline of multiple rules<a class="anchor" aria-label="anchor" href="#a-pipeline-of-multiple-rules"></a>
</h2>
<hr class="half-width">
<p>In this episode, we will plot the scaling results generated in the
last episode using the script <code>plot_terse_amdahl_results.py</code>.
These results report how long the work of running <code>amdahl</code>
took when using between 2 and 36 processes.</p>
<p>We want to plot these results automatically, i.e. as part of our
workflow. In order to do this correctly, we need to make sure that our
python plotting script runs only <strong>after</strong> we have finished
calculating all results.</p>
<p>We can control the order and relative timing of when steps execute by
defining dependencies.</p>
<p>For example, consider the following YAML,
<code>depends.yaml</code>:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Dependency-exploration</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Experiment with adding dependencies</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode5</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> date.txt</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> date-batch</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the date and node's hostname to a file</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>              echo "From batch node:" &gt;&gt; $(OUTPUT)</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>              hostname &gt;&gt; $(OUTPUT)</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>              date &gt;&gt; $(OUTPUT)</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>              sleep 10</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> date-login</span></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the date and login node's hostname to a file</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a>              echo "From login node:" &gt;&gt; $(OUTPUT)</span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>              hostname &gt;&gt; $(OUTPUT)</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>              date &gt;&gt; $(OUTPUT)</span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a>              sleep 10</span></code></pre>
</div>
<p>This script has two steps, each of which writes the type of node of
its host, the particular hostname, and the date/time before waiting for
10 seconds. The step <code>date-login</code> is run on a login node and
the step <code>date-batch</code> is run on a “batch” or “compute”
node.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Run the above script with</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">maestro</span> run depends.yaml</span></code></pre>
</div>
<p>You can then <code>cat</code> the output of both steps to
<code>stdout</code> via a command of the form</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">cat</span> Episode5/Dependency-exploration-{FILL}/date-<span class="pp">*</span>/<span class="pp">*</span>.txt</span></code></pre>
</div>
<p>where <code>{FILL}</code> should be replaced by the date/time info of
this run. This will print the output of the two steps to
<code>stdout</code>.</p>
<p>Which step is printed first and how close together are they
completed?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>You’ll likely see output somewhat similar to</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">(</span><span class="ex">maestro_venv</span><span class="kw">)</span> <span class="ex">janeh@pascal83:~$</span> cat Episode5/Dependency-exploration_20240326-143559/date-<span class="pp">*</span>/date.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>From batch node:
pascal16
Tue Mar 26 14:36:04 PDT 2024
From login node:
pascal83
Tue Mar 26 14:36:03 PDT 2024</code></pre>
</div>
<p>though the times/dates and hostnames will be different. We didn’t try
to control the order of operations, so each step will have run as soon
as it had resources. Probably you’ll see that the timestamp on the login
node is earlier because it will not have to wait for resources from the
queue.</p>
</div>
</div>
</div>
</div>
<p>Next, let’s add a dependency to ensure that the batch step runs
<strong>before</strong> the login node step. To add a dependency a line
with the following format must be added to a step’s <code>run</code>
block:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="at">        </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">`</span><span class="kw">{</span><span class="at">STEP NAME</span><span class="kw">}</span><span class="at">`</span><span class="kw">]</span></span></code></pre>
</div>
<p><code>{STEP NAME}</code> is replaced by the name of the step from the
study that you want the current step to depend upon.</p>
<p>If we update <code>date-login</code> to include a dependency, we’ll
see</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> date-login</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Write the date and login node's hostname to a file</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>              echo "From login node:" &gt;&gt; $(OUTPUT)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>              hostname &gt;&gt; $(OUTPUT)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>              date &gt;&gt; $(OUTPUT)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>              sleep 10</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="at">          </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">date-batch</span><span class="kw">]</span></span></code></pre>
</div>
<p>Now <code>date-login</code> will not run until
<code>date-batch</code> has finished.</p>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>Update <code>depends.yaml</code> to make <code>date-login</code> wait
for <code>date-batch</code> to complete before running. Then rerun
<code>maestro run depends,yaml</code>.</p>
<p>How has the output of the two <code>date.txt</code> files
changed?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>This time, you should see that the date printed from the login node
is <em>at least</em> 10 seconds later than the date printed on the batch
node. For example, on Pascal I see</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">$</span> cat Episode5/Dependency-exploration_20240326-150950/date-<span class="pp">*</span>/date.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>From batch node:
pascal16
Tue Mar 26 15:09:54 PDT 2024
From login node:
pascal83
Tue Mar 26 15:10:53 PDT 2024</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="a-step-that-waits-for-all-iterations-of-its-dependency"><h2 class="section-heading">A step that waits for all iterations of its dependency<a class="anchor" aria-label="anchor" href="#a-step-that-waits-for-all-iterations-of-its-dependency"></a>
</h2>
<hr class="half-width">
<p>Let’s return to our Amdahl scaling study and the YAML with which we
ended in the last episode:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="at">      </span><span class="fu">P</span><span class="kw">:</span><span class="at"> </span><span class="fl">.999</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> amdahl.json</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode5</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> amdahl</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> $(TASKS)</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:00:30"</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">18</span><span class="kw">,</span><span class="at"> </span><span class="dv">24</span><span class="kw">,</span><span class="at"> </span><span class="dv">36</span><span class="kw">]</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span></code></pre>
</div>
<p>Ultimately we want to add a plotting step that depends upon
<code>amdahl</code>, but for now let’s create a placeholder that will go
under <code>study</code> and beneath <code>amdahl</code>:</p>
<pre><code>   - name: plot
      description: Create a plot from `amdahl` results
      run:
          # We'll update this `cmd` later
          cmd: |
               echo "This is where we plot"</code></pre>
<p>Based on what we saw before, we might think that we just need to
add</p>
<pre><code>          depends: [amdahl]</code></pre>
<p>to the end of this block. Instead, the syntax changes slightly
because <code>amdahl</code> is parameterized – i.e. it will run for
several task values. To indicate that we want <code>plot</code> to run
after <em>ALL</em> <code>amdahl</code> steps, we’ll add a
<code>_*</code> to the end of the step name:</p>
<pre><code>          depends: [amdahl_*]</code></pre>
<p>Now our new step definition will look like</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> plot</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Create a plot from `amdahl` results</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co">          # We'll update this `cmd` later</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>               echo "This is where we plot"</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="at">          </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">amdahl_</span><span class="ot">*]</span></span></code></pre>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge3"></a>
</h3>
<div class="callout-content">
<p>Experiment with defining your dependency as both</p>
<pre><code>depends: [amdahl_*]</code></pre>
<p>and</p>
<pre><code>depends: [amdahl]</code></pre>
<p>in different <strong>dry</strong> runs. How do the output directory
structures differ? What’s the difference in behavior?</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">Show me the solution</h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">

</div>
</div>
</div>
</div>
</section><section id="using-the-outputs-from-a-previous-step"><h2 class="section-heading">Using the outputs from a previous step<a class="anchor" aria-label="anchor" href="#using-the-outputs-from-a-previous-step"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="manually-plotting-scaling-results">Manually plotting scaling results<a class="anchor" aria-label="anchor" href="#manually-plotting-scaling-results"></a>
</h3>
<p>In your working directory, you should have a copy of
<code>plot_terse_amdahl_results.py</code>. The syntax for running this
script is</p>
<pre><code>python3 plot_terse_amdahl_results.py {output image name} {input json filenames}</code></pre>
<p>Before trying to add this command to our workflow, let’s run it
manually to see how it works. We can call the output image
<code>output.jpg</code>. As for the input names, we can use the
<code>.json</code> files created at the end of episode 4. In particular
if you run</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">ls</span> Episode4/Amdahl_<span class="op">&lt;</span>Date<span class="op">&gt;</span>_<span class="op">&lt;</span>Time<span class="op">&gt;</span>/amdahl/TASKS.<span class="pp">*</span>/amdahl.json</span></code></pre>
</div>
<p>using the <code>&lt;Date&gt;</code> and <code>&lt;Time&gt;</code> of
your last run in Episode 4, you should see a list of files named
<code>amdahl.json</code>:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="ex">$</span> ls Episode4/Amdahl_20240326-155434/amdahl/TASKS.<span class="pp">*</span>/amdahl.json</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">Episode4</span><span class="op">/</span><span class="va">Amdahl_20240326</span><span class="op">-</span><span class="fl">155434</span><span class="op">/</span><span class="va">amdahl</span><span class="op">/</span><span class="va">TASKS.18</span><span class="op">/</span><span class="va">amdahl.json</span></span>
<span><span class="va">Episode4</span><span class="op">/</span><span class="va">Amdahl_20240326</span><span class="op">-</span><span class="fl">155434</span><span class="op">/</span><span class="va">amdahl</span><span class="op">/</span><span class="va">TASKS.24</span><span class="op">/</span><span class="va">amdahl.json</span></span>
<span><span class="va">Episode4</span><span class="op">/</span><span class="va">Amdahl_20240326</span><span class="op">-</span><span class="fl">155434</span><span class="op">/</span><span class="va">amdahl</span><span class="op">/</span><span class="va">TASKS.2</span><span class="op">/</span><span class="va">amdahl.json</span></span>
<span><span class="va">Episode4</span><span class="op">/</span><span class="va">Amdahl_20240326</span><span class="op">-</span><span class="fl">155434</span><span class="op">/</span><span class="va">amdahl</span><span class="op">/</span><span class="va">TASKS.36</span><span class="op">/</span><span class="va">amdahl.json</span></span>
<span><span class="va">Episode4</span><span class="op">/</span><span class="va">Amdahl_20240326</span><span class="op">-</span><span class="fl">155434</span><span class="op">/</span><span class="va">amdahl</span><span class="op">/</span><span class="va">TASKS.4</span><span class="op">/</span><span class="va">amdahl.json</span></span>
<span><span class="va">Episode4</span><span class="op">/</span><span class="va">Amdahl_20240326</span><span class="op">-</span><span class="fl">155434</span><span class="op">/</span><span class="va">amdahl</span><span class="op">/</span><span class="va">TASKS.8</span><span class="op">/</span><span class="va">amdahl.json</span></span></code></pre>
</div>
<p>You can use this same filepath with wildcards to specify this list of
JSON files as inputs to our python script:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">python3</span> plot_terse_amdahl_results.py output.jpg Episode4/Amdahl_<span class="op">&lt;</span>Date<span class="op">&gt;</span>_<span class="op">&lt;</span>Time<span class="op">&gt;</span>/amdahl/TASKS.<span class="pp">*</span>/amdahl.json</span></code></pre>
</div>
<div id="challenge4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge4"></a>
</h3>
<div class="callout-content">
<p>Generate a scaling plot by manually specifying the JSON files
produced from a previous run of <code>amdahl.yaml</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">Show me the solution</h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>The resulting JPEG should look something like</p>
<figure><img src="../files/example-scaling-plot.jpg" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="adding-plotting-to-our-workflow">Adding plotting to our workflow<a class="anchor" aria-label="anchor" href="#adding-plotting-to-our-workflow"></a>
</h3>
<p>Let’s update our <code>plot</code> step in <code>amdahl.yaml</code>
to include python plotting rather than a placeholder <code>echo</code>
command. We want the updated step to look something like</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> plot</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Create a plot from `amdahl` results</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>               python3 plot_terse_amdahl_results.py output.jpg Episode5/Amdahl_&lt;Date&gt;_&lt;Time&gt;/amdahl/TASKS.*/amdahl.json</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="at">          </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">amdahl_</span><span class="ot">*]</span></span></code></pre>
</div>
<p>The trouble is that we don’t know the exact value of
<code>Episode5/Amdahl_&lt;Date&gt;_&lt;Time&gt;/amdahl</code> for a job
that we haven’t run yet. Luckily Maestro gives us a placeholder to the
equivalent of this path for the current job —
<code>$(amdahl.workspace)</code>. This is the workspace for the
<code>amdahl</code> step, where all outputs for <code>amdahl</code>,
including our <code>TASKS.*</code> directories, are written.</p>
<p>This means we can update the <code>plot</code> step as follows:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> plot</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Create a plot from `amdahl` results</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>               python3 plot_terse_amdahl_results.py output.jpg $(amdahl.workspace)/TASKS.*/amdahl.json</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="at">          </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">amdahl_</span><span class="ot">*]</span></span></code></pre>
</div>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>Where does the <code>plot_terse_amdahl_results.py</code> script live?
In Maestro, <code>$(SPECROOT)</code> specifies the root directory from
which you originally ran <code>maestro run...</code>. This is where
<code>plot_terse_amdahl_results.py</code> should live, so let’s be more
precise:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> plot</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Create a plot from `amdahl` results</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>               python3 $(SPECROOT)/plot_terse_amdahl_results.py output.jpg $(amdahl.workspace)/TASKS.*/amdahl.json</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="at">          </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">amdahl_</span><span class="ot">*]</span></span></code></pre>
</div>
</div>
</div>
</div>
<div id="challenge5" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge5"></a>
</h3>
<div class="callout-content">
<p>Update <code>amdahl.yaml</code> so that</p>
<ul>
<li>one step definiton runs <code>amdahl</code> for 85% parallelizable
code using [2, 4, 8, 16, 32] tasks</li>
<li>a second step plots the results.</li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5">Show me the solution</h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" data-bs-parent="#accordionSolution5" aria-labelledby="headingSolution5">
<div class="accordion-body">
<p>Your YAML file should look something like</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="at">      </span><span class="fu">P</span><span class="kw">:</span><span class="at"> </span><span class="fl">.85</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> amdahl.json</span></span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode5</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> run-amdahl</span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> $(TASKS)</span></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:01:30"</span></span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> plot</span></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Create a plot from `amdahl` results</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a>               python3 $(SPECROOT)/plot_terse_amdahl_results.py output.jpg $(run-amdahl.workspace)/TASKS.*/amdahl.json</span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a><span class="at">          </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">amdahl_</span><span class="ot">*]</span></span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">]</span></span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="errors-are-normal" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="errors-are-normal" class="callout-inner">
<h3 class="callout-title">Errors are normal<a class="anchor" aria-label="anchor" href="#errors-are-normal"></a>
</h3>
<div class="callout-content">
<p>Don’t be disheartened if you see errors when first testing your new
Maestro pipelines. There is a lot that can go wrong when writing a new
workflow, and you’ll normally need several iterations to get things just
right. Luckily, <code>Maestro</code> will do some checks for consistency
at the outset of the run. If you specify a dependency that doesn’t exist
(because of a rename, for example), the job will fail before submitting
work to the queue.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“We can control the order of steps run in a study by creating
dependencies.”</li>
<li>“You can create a dependency with the
<code>depends: [{step name}]</code> syntax.”</li>
<li>“Dependency syntax changes to <code>depends: [{step name}_*]</code>
for parameterized steps.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section><section id="aio-06-multiple-parameters"><p>Content from <a href="06-multiple-parameters.html">Multiple parameters</a></p>
<hr>
<p>Last updated on 2024-04-16 |
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/06-multiple-parameters.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 80 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I specify multiple parameters?”</li>
<li>“How do multiple parameters interact?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Create scaling results for different proportions of parallelizable
code.”</li>
<li>“Create and compare scalability plots for codes with different
amounts of parallel work.”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section id="adding-a-second-parameter"><h2 class="section-heading">Adding a second parameter<a class="anchor" aria-label="anchor" href="#adding-a-second-parameter"></a>
</h2>
<hr class="half-width">
<p>In this episode, we want to vary <code>P</code>, the fraction of
parallel code, as part of our workflow. To do this, we will add a second
entry under <code>global.parameters</code> and remove the definition for
<code>P</code> under <code>env</code>:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="at">(...)</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> amdahl.json</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode6</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="at">(...)</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">]</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="at">    </span><span class="fu">P</span><span class="kw">:</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">&lt;Insert values&gt;</span><span class="kw">]</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> P.%%</span></span></code></pre>
</div>
<p>How many values do we want to include for <code>P</code>? We need to
have <strong>the same number</strong> of values listed for all
<code>global.parameters</code>. This means that to run the previous
scaling study with <code>P=.85</code>, and five values for
<code>TASKS</code>, our global parameters section would specify
<code>.85</code> for <code>P</code> five times:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">]</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="at">    </span><span class="fu">P</span><span class="kw">:</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">]</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> P.%%</span></span></code></pre>
</div>
<p>Let’s say we want to perform the same scaling study for a second
value of P, <code>.99</code>. This means that we’d have to repeat the
same 5 values for <code>TASKS</code> and then provide the second value
of <code>P</code> 5 times:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">,</span><span class="at"> </span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">]</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="at">    </span><span class="fu">P</span><span class="kw">:</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">]</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> P.%%</span></span></code></pre>
</div>
<p>At this point, our entire YAML file should look something like</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> amdahl.json</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode6</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> run-amdahl</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> $(TASKS)</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:01:30"</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> plot</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Create a plot from `amdahl` results</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>               python3 $(SPECROOT)/plot_terse_amdahl_results.py output.jpg $(run-amdahl.workspace)/TASKS.*/amdahl.json</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a><span class="at">          </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">amdahl_</span><span class="ot">*]</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">,</span><span class="at"> </span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">]</span></span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a><span class="at">    P:</span></span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a><span class="at">        values: [.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">]</span></span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> P.%%</span></span></code></pre>
</div>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge1"></a>
</h3>
<div class="callout-content">
<p>Run the workflow above. Do you generate <code>output.jpg</code>? If
not, why not?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>If you use the YAML above, your <code>amdahl-run</code> steps should
work, but your <code>plot</code> step will fail. <code>plot</code>’s
failure will be evident both because <code>output.jpg</code> will be
missing from the <code>plot</code> subdirectory <strong>and</strong>
because the <code>plot.*.err</code> file in the same directory will
contain an error:</p>
<pre><code>Traceback (most recent call last):
  File "/p/lustre1/janeh/test-maestro/snakemake-port/ep6/plot_terse_amdahl_results.py", line 46, in &lt;module&gt;
    process_files(filenames, output=output)
  File "/p/lustre1/janeh/test-maestro/snakemake-port/ep6/plot_terse_amdahl_results.py", line 10, in process_files
    with open(filename, 'r') as file:
FileNotFoundError: [Errno 2] No such file or directory: '/g/g0/janeh/Episode6/Amdahl_20240328-163359/run-amdahl/TASKS.*/amdahl.json'</code></pre>
<p>The problem is that the directory path for <code>.json</code> files
has changed. This will be discussed more below!</p>
</div>
</div>
</div>
</div>
<p>The trouble with the YAML above is that our output directory
structure changed when we added a second global parameter, but we didn’t
update the directory path specified under <code>plot</code>.</p>
<p>If we look inside the <code>run-amdahl</code> output folder
(identified as <code>$(run-amdahl.workspace)</code> in our workflow
YAML), its subdirectory names now include information about both global
parameters:</p>
<pre><code>janeh@pascal83:~/Episode6/Amdahl_20240328-163359/run-amdahl$ ls
P.0.85.TASKS.16  P.0.85.TASKS.8   P.0.99.TASKS.4
P.0.85.TASKS.2   P.0.99.TASKS.16  P.0.99.TASKS.8
P.0.85.TASKS.32  P.0.99.TASKS.2
P.0.85.TASKS.4   P.0.99.TASKS.32</code></pre>
<p>whereas directory path for our <code>.json</code> files is specified
as <code>$(run-amdahl.workspace)/TASKS.*/amdahl.json</code> under the
<code>plot</code> step.</p>
<p>We could get the <code>plot</code> step to work by simply adding a
wildcard, <code>*</code>, in front of <code>TASKS</code> so that the
path to <code>.json</code> files would be</p>
<pre><code>$(run-amdahl.workspace)/*TASKS.*/amdahl.json</code></pre>
<p>and the definition for <code>plot</code> would be</p>
<pre><code>    - name: plot
      description: Create a plot from `amdahl` results
      run:
          cmd: |
               python3 $(SPECROOT)/plot_terse_amdahl_results.py output.jpg $(run-amdahl.workspace)/*TASKS.*/amdahl.json
          depends: [amdahl_*]</code></pre>
<p>This would allow <code>plot</code> to terminate happily and to
produce an <code>output.jpg</code> file, but that image would plot
output from all <code>.json</code> files as a single line, and we
wouldn’t be able to tell which data points corresponded to a parallel
fraction, <code>P</code>, of <code>.85</code> and which corresponded to
<code>P=.99</code>.</p>
<p>If we can generate two plots – one for each value of <code>P</code> –
we’ll more clearly be able to see scaling behavior for these two
situations. We can generate two separate plots by calling
<code>python3 plot_terse_amdahl_results.py ...</code> on two sets of
input files – those in the <code>P.0.85.TASKS*</code> subdirectories of
<code>$(run-amdahl.workspace)</code> and those in the
<code>P.0.99.TASKS*</code> subdirectories.</p>
<p>That means we can generate these two plots by inserting the variable
<code>$(P)</code> into the path —</p>
<pre><code>$(run-amdahl.workspace)/P.$(P).TASKS.*/amdahl.json</code></pre>
<p>making the definition for <code>plot</code></p>
<pre><code>    - name: plot
      description: Create a plot from `amdahl` results
      run:
          cmd: |
               python3 $(SPECROOT)/plot_terse_amdahl_results.py output.jpg $(run-amdahl.workspace)/P.$(P).TASKS.*/amdahl.json
          depends: [amdahl_*]</code></pre>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge<a class="anchor" aria-label="anchor" href="#challenge2"></a>
</h3>
<div class="callout-content">
<p>Modify your workflow as discussed above to generate output plots for
two different values of P. Open these plots and verify they are
different from each other. How does changing the workflow to generate
two separate plots change the directory structure?</p>
<p>(Feel free to use .85 and .99 or to modify to other values of your
choosing.)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>Your full YAML file should be similar to</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">YML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yml" tabindex="0"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Amdahl</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Run a parallel program</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="fu">batch</span><span class="kw">:</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="at">    </span><span class="fu">host</span><span class="kw">:</span><span class="at"> quartz</span><span class="co"> # machine to run on</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="at">    </span><span class="fu">bank</span><span class="kw">:</span><span class="at"> guests</span><span class="co"> # bank</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="at">    </span><span class="fu">queue</span><span class="kw">:</span><span class="at"> pdebug</span><span class="co"> # partition</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT</span><span class="kw">:</span><span class="at"> amdahl.json</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="at">      </span><span class="fu">OUTPUT_PATH</span><span class="kw">:</span><span class="at"> ./Episode6</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="fu">study</span><span class="kw">:</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> run-amdahl</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> run in parallel</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a><span class="co">          # Here's where we include our MPI wrapper:</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>               $(LAUNCHER) amdahl --terse -p $(P) &gt;&gt; $(OUTPUT)</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a><span class="at">          </span><span class="fu">nodes</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a><span class="at">          </span><span class="fu">procs</span><span class="kw">:</span><span class="at"> $(TASKS)</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a><span class="at">          </span><span class="fu">walltime</span><span class="kw">:</span><span class="at"> </span><span class="st">"00:01:30"</span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> plot</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Create a plot from `amdahl` results</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a><span class="fu">          cmd</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>               python3 $(SPECROOT)/plot_terse_amdahl_results.py output.jpg $(run-amdahl.workspace)/P.$(P).TASKS.*/amdahl.json</span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a><span class="at">          </span><span class="fu">depends</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">amdahl_</span><span class="ot">*]</span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a><span class="fu">global.parameters</span><span class="kw">:</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a><span class="at">    </span><span class="fu">TASKS</span><span class="kw">:</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a><span class="at">        </span><span class="fu">values</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">,</span><span class="at"> </span><span class="dv">2</span><span class="kw">,</span><span class="at"> </span><span class="dv">4</span><span class="kw">,</span><span class="at"> </span><span class="dv">8</span><span class="kw">,</span><span class="at"> </span><span class="dv">16</span><span class="kw">,</span><span class="at"> </span><span class="dv">32</span><span class="kw">]</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> TASKS.%%</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a><span class="at">    P:</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a><span class="at">        values: [.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.85</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">,</span><span class="at"> </span><span class="fl">.99</span><span class="kw">]</span></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a><span class="at">        </span><span class="fu">label</span><span class="kw">:</span><span class="at"> P.%%</span></span></code></pre>
</div>
<p>Modifying <code>plot</code> to include <code>$(P)</code> caused this
step to run twice. As a result, two subdirectories under
<code>plot</code> were created – one for each value of P:</p>
<pre><code>(maestro_venv) janeh@pascal83:~/Episode6/Amdahl_20240328-171343/plot$ ls
P.0.85  P.0.99</code></pre>
</div>
</div>
</div>
</div>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>Instead of modifying the path to our <code>amdahl.json</code> files
to <code>$(run-amdahl.workspace)/P.$(P).TASKS.*/amdahl.json</code>, we
could have equivalently updated it to
<code>$(run-amdahl.workspace)/$(P.label).TASKS.*/amdahl.json</code>.</p>
<p>In other words, <code>P.$(P)</code> is equivalent to
<code>$(P.label)</code>. Similarly, in Maestro,
<code>TASKS.$(TASKS)</code> is equivalent to
<code>$(TASKS.label)</code>. This syntax works for every global
parameter in Maestro.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>“Multiple parameters can be defined under
<code>global.parameters</code>.”</li>
<li>“Lists of values for all global parameters must have the same
length; the Nth entries in the lists of values for all global parameters
are used in a single job.”</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:maintainers-hpc@lists.carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.4" class="external-link">sandpaper (0.16.4)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.5" class="external-link">pegboard (0.7.5)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.2" class="external-link">varnish (1.0.2)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "HPC Carpentry, maestrowf, maestro, workflows, hpc",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "identifier": "https://carpentries-incubator.github.io/hpc-workflows/instructor/aio.html",
  "dateCreated": "2024-04-02",
  "dateModified": "2024-04-17",
  "datePublished": "2024-04-17"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

